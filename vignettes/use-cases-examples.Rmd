---
title: "use-cases-examples"
output: rmarkdown::html_vignette
# vignette: >
# %\VignetteIndexEntry{use-cases-examples}
#   %\VignetteEngine{knitr::rmarkdown}
#   %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(disaggR)
library(ggplot2)
library(matrixStats)
library(reshape2)
devtools::load_all()
```

## Example 1: Carbon Footprint of Aluminum Used in Vehicle Manufacturing

Imagine an Industrial Ecology researcher assessing the carbon footprint
associated with aluminum usage in vehicle manufacturing. Vehicles
contain aluminum sourced from different primary and secondary production
routes or from imports, each having considerably different environmental
footprints.

![Example 1: Carbon Footprint of Aluminum Used in Vehicle
Manufacturing](images/example_aluminium.png)

The researcher split their analysis into two distinct models:

-   Model 1: Disaggregating the aluminum sources used in vehicle
    manufacturing
-   Model 2: Life Cycle Assessment (LCA) of carbon footprint of the
    aluminum used in vehicle manufacturing

### Model 1: Disaggregating Aluminum Sources

We assume that the researcher has the following pieces of information:

1.  a total aluminum consumption figure for vehicle manufacturing (e.g.,
    500,000 tonnes/year)
2.  an uncertainty estimate for that total (e.g. a standard deviation of
    25,000)
3.  proxy data to calculate "best-guesses" of the shares for the three
    aluminum production routes (e.g. primary aluminum: 40%, secondary
    aluminum: 45%, imported aluminum: 15%)

With the `disaggR` package, getting samples for the three disaggregate
aluminum production routes while accounting for the underlying
uncertainties and correlations is simply one function call:

```{r}
sample <- rdisagg(n = 1E5, # sample size
                  mean_0 = 500000, # best guess for total
                  sd_0 = 500000/2, #25000, # standard deviation for total
                  min = 0,
                  shares = c("primary" = 0.4, # best guesses for the shares
                             "secondary" = 0.45, 
                             "imported" = 0.15), 
                  sds = c("primary" = 0.04, # best guesses for the shares
                             "secondary" = 0.045, 
                             "imported" = 0.015),
                  log = TRUE)

sample <- rdisagg(n = 1E5, # sample size
                  mean_0 = 100, # best guess for total
                  sd_0 = 5, #25000, # standard deviation for total
                  min = 0,
                  shares = c("primary" = 0.1, # best guesses for the shares
                             "secondary" = 0.3, 
                             "imported" = 0.6),
                  log = TRUE)

```

The `sample` object is a matrix with three columns (one for each
aluminum production route) and `n = 1E5` rows:

```{r}
head(sample)
```

Let's plot the individual samples as histograms:

```{r}
# reshape to long data.frame
sample_df <- reshape2::melt(sample, varnames = c('iteration', 'aluminum_source'))

# plot using ggplot
ggplot(sample_df, aes(x = value, col = aluminum_source, fill = aluminum_source))+ 
  geom_histogram(alpha = 0.3, position = 'identity')
```

#### Consistency checks

Next we check whether sample generated by `rdisagg()` is consistent with
the information the researcher provided in the beginning. First, we look
at the total aluminum production by summing the disaggregates:

```{r}
# row wise sum the sample matrix
sample_total <- rowSums(sample)

cat("Mean of the sampled total: ", mean(sample_total))
cat("SD of the sampled total", sd(sample_total))

```

Indeed, the sample mean and SD are very close to the ones passed to
`rdisagg`.

Next, we look if the sample is consistent with the provided shares:

```{r}
# row wise divide the disaggregate samples by the total
sample_shares <- sample / sample_total

cat("Means of the sampled shares: ", colMeans(sample_shares))
```

Again, very close to the shares provided in the beginning.

#### Correlations

As the shares were sampled from a Dirichlet distribution, they naturally
sum to one...

```{r}
print(all.equal(rowSums(sample_shares), rep(1, nrow(sample_shares))))
```

... and they are correlated:

```{r}
# calculate pearson correlation matrix
cor_mat <- cor(sample)
cor_mat
```

The sign of the correlation depends on the magnitude of the uncertainty
of the aggregate and the shares. In this case, we assumed a moderate
uncertainty on the total (a coefficient of variation of 10%) and a
maximum high uncertainty of the shares[^1], leading to negative
correlations between the three individual components.

[^1]: Since we did not specify the uncertainty of the shares (`sds`
    equals `NULL` by default), the concentration parameter `gamma` of
    the Dirichlet distribution is estimated based on the principle of
    Maximum Entropy

However, if we assume instead a very large uncertainty on the aggregate,
e.g. a SD of 500,000 (reflecting a coefficient of variation of 100%):

```{r}
sample2 <- rdisagg(n = 1E5, 
                   mean_0 = 500000, 
                   sd_0 = 500000, # large standard deviation for total
                   shares = c("primary" = 0.1, 
                              "secondary" = 0.45, 
                              "imported" = 0.45))

```

The correlations become positive:

```{r}
# calculate pearson correlation matrix
cor_mat2 <- cor(sample2)
cor_mat2
```

#### Sharing results

As shown in ...

```{r}
result_summary <- list(
  mean = colMeans(sample), 
  sd = colSds(sample), 
  meanlog = colMeans(log(sample)), 
  sdlog = colSds(log(sample))
)
print(result_summary)
```

```{r}

```

### Model 2 â€“ Life Cycle Assessment (LCA) of Carbon Footprint

The LCA model applies different emission factors depending on the
aluminum production route. We assume reasonable emission factors of 16
$tCO_2/tonne$ for primary aluminum, 1 $tCO_2/tonne$ for recycled
aluminum and 8 $tCO_2/tonne$ for imported aluminum.

```{r}
emission_factors <- c('primary' = 1, 
                      'secondary' = 1, 
                      'imported'= 1)
```

Case 0: full samples

```{r}
sample_emissions_full <- sample * emission_factors
total_emissions_full <- rowSums(sample_emissions_full)
```


```{r}
cor(sample_emissions_full)
```


```{r}
cat("Mean emissions: ", mean(total_emissions_full))
cat("SD emissions: ", sd(total_emissions_full))
cat("CV emissions: ", sd(total_emissions_full) / mean(total_emissions_full))

```

Case 1: univariate

```{r}
# sample from summary statistics
sample_alum_univariate <- data.frame(
  'primary' = rtruncnorm(1E5, 
                         a = 0,
                         mean = result_summary$mean[1], 
                         sd = result_summary$sd[1]), 
  'secondary' = rtruncnorm(1E5, 
                           a = 0,
                           mean = result_summary$mean[2], 
                           sd = result_summary$sd[2]), 
  'imports' = rtruncnorm(1E5, 
                         a = 0,
                         mean = result_summary$mean[3], 
                         sd = result_summary$sd[3])
)
# sample_alum_univariate <- data.frame(
#   'primary' = rlnorm(1E5, 
#                          meanlog = result_summary$meanlog[1], 
#                          sdlog = result_summary$sdlog[1]), 
#   'secondary' = rlnorm(1E5, 
#                            meanlog = result_summary$meanlog[2], 
#                            sdlog = result_summary$sdlog[2]), 
#   'imports' = rlnorm(1E5, 
#                          meanlog = result_summary$meanlog[3], 
#                          sdlog = result_summary$sdlog[3])
# )

```

```{r}
sample_emissions_univariate <- sample_alum_univariate * emission_factors
total_emissions_univariate <- rowSums(sample_emissions_univariate)
```

```{r}
cat("Mean emissions: ", mean(total_emissions_univariate))
cat("SD emissions: ", sd(total_emissions_univariate))
cat("CV emissions: ", sd(total_emissions_univariate) / mean(total_emissions_univariate))

```

```{r}

```

```{r}
test <- data.table(
  univariate = total_emissions_univariate, 
  original = total_emissions_full
) %>% data.table::melt()
test[,max(value), by = variable]

test %>% 
  ggplot(aes(x = value, col = variable, fill = variable)) + 
  geom_histogram(alpha = 0.3, position = 'identity')
```
